#!/bin/sh

DEBUG=0
SCRIPT=$(readlink -f "$0")
SCRIPTPATH=$(dirname "$SCRIPT")
LOGPATH=/dev/null
SCRIPT_ARGS=$@

export LD_LIBRARY_PATH="${SCRIPTPATH}/headunit_libs:/jci/lib:/jci/opera/3rdpartylibs/freetype:/usr/lib/imx-mm/audio-codec:/usr/lib/imx-mm/video-codec:/usr/lib/imx-mm/parser:/data_persist/dev/lib:"
#override some GST plugins with these
export GST_PLUGIN_PATH="${SCRIPTPATH}/headunit_libs:/usr/lib/gstreamer-0.10"

if [ $DEBUG -ne 0 ]; then
  LOGPATH=/data/headunit.log
  if [ -e $LOGPATH ]; then
    LOGSIZE=$(stat -c%s "$LOGPATH")
    if [ $LOGSIZE -gt 10000000 ]; then
      # Delete log file if size exceeds 10 MB
      echo "Delete Log"
      rm -f $LOGPATH
    fi
  fi
fi

echo "****************************" >> ${LOGPATH}
hwclock --hctosys
echo "START HEADUNIT LOG - $(date +'%D %T')" >> ${LOGPATH}

if ! [ -e /tmp/root/headunit.json ]; then
 cp "${SCRIPTPATH}/headunit.json" /tmp/root/
fi

iptables -A INPUT -p tcp --dport 30515 -m state --state NEW,ESTABLISHED -j ACCEPT

rm -f /tmp/root/headunit.status /tmp/root/headunit-wireless.status

# prevent conflict by Official AA
killall -q -9 aap_service carplayd L_jciCARPLAY L_jciAAPA

# loop forever. every 5 seconds,
while true
do
  "${SCRIPTPATH}/headunit"
  retVal=$?
  if [ $retVal -eq 0 ]; then
    break;
  fi

 RAND=`expr $RANDOM % 5 + 3`
 #echo "go sleep $RAND"
 sleep $RAND

done
